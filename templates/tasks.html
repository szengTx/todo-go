{{define "title"}}我的任务 - 任务管理系统{{end}}
{{define "content"}}
<h2>我的任务</h2>

<div class="view-switcher">
    <button id="list-view-btn" class="active">列表视图</button>
    <button id="calendar-view-btn">日历视图</button>
</div>


<div id="task-list">
    {{if .error}}
    <p style="color: red;">{{.error}}</p>
    {{end}}

    <form action="/tasks/create" method="post" id="task-form">
        <input type="text" name="title" placeholder="输入新任务..." required>
        <div class="form-inline">
            <label class="inline"><input type="checkbox" name="all_day" id="all-day" checked> 全天</label>
            <input type="date" name="deadline_date" placeholder="选择日期">
            <input type="time" name="deadline_time" id="deadline-time" placeholder="截止时间" style="display:none;">
        </div>
        <button type="submit">添加任务</button>
    </form>

    <ul>
        {{range .Tasks}}
        <li>
            <form action="/tasks/toggle/{{.ID}}" method="post" style="display: inline;">
                <input type="checkbox" {{if .Completed}}checked{{end}} onchange="this.form.submit()">
            </form>
            <div>
                <span class="task-title {{if .Completed}}completed{{end}}">{{.Title}}</span>
                {{if .Deadline}}
                <div class="pill">截止: {{if .AllDay}}{{.Deadline.Format "2006-01-02"}}{{else}}{{.Deadline.Format "2006-01-02 15:04"}}{{end}}</div>
                {{end}}
            </div>
            <div class="actions">
                <a href="/tasks/delete/{{.ID}}">删除</a>
            </div>
        </li>
        {{end}}
    </ul>
</div>

<div id="calendar-view" style="display: none;">
    <div id="calendar"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const listViewBtn = document.getElementById('list-view-btn');
        const calendarViewBtn = document.getElementById('calendar-view-btn');
        const taskListDiv = document.getElementById('task-list');
        const calendarViewDiv = document.getElementById('calendar-view');
        const calendarEl = document.getElementById('calendar');
        const allDayCheckbox = document.getElementById('all-day');
        const deadlineTimeInput = document.getElementById('deadline-time');

        let calendar;

        function showListView() {
            taskListDiv.style.display = 'block';
            calendarViewDiv.style.display = 'none';
            listViewBtn.classList.add('active');
            calendarViewBtn.classList.remove('active');
        }

        function showCalendarView() {
            taskListDiv.style.display = 'none';
            calendarViewDiv.style.display = 'block';
            listViewBtn.classList.remove('active');
            calendarViewBtn.classList.add('active');

            if (!calendar) {
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,listWeek'
                    },
                    events: '/tasks/json',
                    locale: 'zh-cn'
                });
                calendar.render();
            }
        }

        listViewBtn.addEventListener('click', showListView);
        calendarViewBtn.addEventListener('click', showCalendarView);

        function toggleTimeInput() {
            const showTime = !allDayCheckbox.checked;
            deadlineTimeInput.style.display = showTime ? 'inline-block' : 'none';
            if (!showTime) {
                deadlineTimeInput.value = '';
            }
        }

        allDayCheckbox.addEventListener('change', toggleTimeInput);
        toggleTimeInput();
    });
</script>

{{end}}

{{define "tasks.html"}}{{template "base" .}}{{end}}