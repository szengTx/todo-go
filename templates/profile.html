{{define "title"}}ä¸ªäººä¸»é¡µ - ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ{{end}}
{{define "content"}}
<h2>ä¸ªäººä¸»é¡µ</h2>

{{if .error}}
<div class="alert">{{.error}}</div>
{{end}}
{{if .success}}
<div class="alert success">{{.success}}</div>
{{end}}

<div class="profile-card">
    <div class="profile-avatar">
        {{if .User.AvatarURL}}
        <img src="{{.User.AvatarURL}}" alt="avatar">
        {{else}}
        <div class="avatar-placeholder">ğŸ˜Š</div>
        {{end}}
    </div>
    <div class="profile-info">
        <div class="pill">ç”¨æˆ·å: {{.User.Username}}</div>
        {{if .User.Email}}
        <div class="pill">é‚®ç®±: {{.User.Email}}</div>
        {{end}}
    </div>
</div>
<div class="upload-row" id="avatar-drop">
    <input type="file" id="avatar-file" accept="image/png, image/jpeg" hidden>
    <p>æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„æˆ– <button type="button" id="pick-btn">é€‰æ‹©æ–‡ä»¶</button></p>
    <small>æ”¯æŒ png / jpgï¼Œæœ€å¤§çº¦ 5MBï¼ˆæµè§ˆå™¨é™åˆ¶ï¼‰ã€‚</small>
</div>

<form action="/profile" method="post" class="profile-form">
    <div class="form-row">
        <label>æ˜¾ç¤ºåç§°</label>
        <input type="text" name="display_name" value="{{.User.DisplayName}}" placeholder="ä½ çš„æ˜µç§°" />
    </div>
    <div class="form-row">
        <label>é‚®ç®±</label>
        <input type="email" name="email" value="{{.User.Email}}" placeholder="name@example.com" />
    </div>
    <div class="form-row">
        <label>å¤´åƒ URLï¼ˆå¯é€‰ï¼‰</label>
        <input type="url" name="avatar_url" value="{{.User.AvatarURL}}" placeholder="https://example.com/avatar.png" />
    </div>
    <button type="submit">ä¿å­˜ä¿¡æ¯</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const drop = document.getElementById('avatar-drop');
    const fileInput = document.getElementById('avatar-file');
    const pickBtn = document.getElementById('pick-btn');
    const avatarImg = document.querySelector('.profile-avatar img');
    const placeholder = document.querySelector('.avatar-placeholder');

    function setPreview(url) {
        if (avatarImg) {
            avatarImg.src = url;
            avatarImg.style.display = 'block';
        }
        if (placeholder) placeholder.style.display = 'none';
    }

    function upload(file) {
        const form = new FormData();
        form.append('avatar', file);
        fetch('/profile/upload', {
            method: 'POST',
            body: form
        }).then(r => r.json()).then(res => {
            if (res.url) {
                setPreview(res.url);
            } else if (res.error) {
                alert(res.error);
            }
        }).catch(() => alert('ä¸Šä¼ å¤±è´¥'));
    }

    ['dragover','dragenter'].forEach(evt => drop.addEventListener(evt, e => {
        e.preventDefault();
        drop.classList.add('drag');
    }));
    ['dragleave','drop'].forEach(evt => drop.addEventListener(evt, e => {
        e.preventDefault();
        drop.classList.remove('drag');
    }));
    drop.addEventListener('drop', e => {
        const file = e.dataTransfer.files[0];
        if (file) upload(file);
    });

    pickBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (file) upload(file);
    });
});
</script>
{{end}}

{{define "profile.html"}}{{template "base" .}}{{end}}
